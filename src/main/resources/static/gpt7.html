<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåœ¨çº¿é—®ç­”</title>
    <script src="marked.min.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            height: 100vh;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        /* é¡¶éƒ¨åŒºåŸŸ */
        .top-bar {
            background: #007bff;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 60px;
            min-height: 60px;
            justify-content: space-between;
            box-sizing: border-box;
        }
        .logo {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
        }
        .menu-items {
            display: flex;
            gap: 18px;
            font-size: 15px;
        }
        .main-layout {
            display: flex;
            flex: 1;
            min-height: 0;
            background: #f4f4f9;
        }
        /* ä¾§è¾¹æ ï¼Œæ”¯æŒæŠ˜å  */
        .sidebar {
            width: 220px;
            min-width: 130px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            transition: width 0.2s;
            position: relative;
        }
        .sidebar.collapsed {
            width: 40px;
            min-width: 40px;
            overflow: hidden;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 12px 10px 16px;
            font-size: 16px;
        }
        .sidebar-btn {
            padding: 7px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 8px 0 8px 16px;
            font-size: 15px;
            display: block;
            width: 120px;
        }
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 2px 0 10px 0;
        }
        .chat-list-item {
            padding: 8px 15px;
            cursor: pointer;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            border-left: 4px solid transparent;
            font-size: 15px;
        }
        .chat-list-item.active {
            background: #e3f2fd;
            border-left: 4px solid #007bff;
            font-weight: bold;
        }
        /* æŠ˜å æŒ‰é’® */
        .sidebar-toggle {
            position: absolute;
            right: -13px;
            top: 10px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 6px #0001;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .sidebar-btn,
        .sidebar.collapsed .chat-list-item {
            display: none;
        }
        .sidebar.collapsed .sidebar-toggle {
            right: -13px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background-color: white;
        }
        .chat-header {
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            background-color: #f8f9fa;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }
        .chat-messages {
            display: flex;
            flex-direction: column;

            flex: 1;
            padding: 15px;
            overflow-y: auto;
            min-height: 0;
        }
        .message {
            display: inline-block;
            max-width: 75%;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            word-break: break-word;
        }

        /* ç”¨æˆ·æ°”æ³¡å³ä¾§ï¼ŒAIå·¦ä¾§ */
        .user-message {
            background-color: #d2f9d1;
            align-self: flex-end;
            color: #222831;
            font-size: 14px;
            line-height: 1.625;
            text-align: left;
        }
        .ai-message {
            background-color: #fff;
            color: #222831;
            font-size: 14px;
            align-self: flex-start;
            text-align: left;
        }
        .ai-message p {
            position: relative;
            padding-left: 2em;
            margin: 5px 0;
        }
        .ai-message p::before {
            content: "ğŸ¤–";
            position: absolute;
            left: 0;
            top: 0;
            font-size: 18px;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            background: #f8f9fa;
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        .chat-input button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #stop-response {
            background-color: #dc3545;
            margin-left: 10px;
        }
        @media (max-width: 800px) {
            .sidebar {
                display: none;
            }
            .main-layout {
                flex-direction: column;
            }
        }
        .model-select-floating {
            position: fixed;
            top: 10px;
            right: 12px;
            z-index: 999;
            background: #fff;
            box-shadow: 0 2px 12px #00000016;
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            border: 1px solid #e0e0e0;
        }
        .model-select-floating select {
            font-size: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            padding: 3px 10px;
        }
        /* æ–°å¢åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-animation {
            display: inline-block;
            font-size: 15px;
            color: dimgray;
            text-align: center;
            margin: 5px 0;
        }
        .loading-dots span {
            animation: dots 1.5s infinite;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.5s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 1s;
        }
        @keyframes dots {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }
    </style>
</head>
<body>
<!-- æµ®åŠ¨æ¨¡å‹ä¸‹æ‹‰ -->
<div class="model-select-floating">
    <label for="model-select" style="margin-right:8px;font-weight:bold;">æ¨¡å‹ï¼š</label>
    <select id="model-select" onchange="changeModel()">
        <option value="model1">deepseek</option>
        <option value="gpt3">gpt3</option>
        <option value="gpt4">gpt4</option>
    </select>
</div>
<div class="app-container">
    <!-- é¡¶éƒ¨logoå’Œèœå• -->
    <div class="top-bar">
        <div class="logo">ğŸ¤– AIé—®ç­”</div>
        <!--
        <div class="menu-items">
            <span>èœå•1</span>
            <span>èœå•2</span>
        </div>
        -->
    </div>
    <!-- ä¸‹æ–¹ä¸»å†…å®¹ï¼šå·¦å³ç»“æ„ -->
    <div class="main-layout">
        <nav class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebar-toggle" title="æŠ˜å /å±•å¼€ä¾§è¾¹æ ">&lt;</button>
            <div class="sidebar-header">ä¼šè¯åˆ—è¡¨</div>
            <button class="sidebar-btn" onclick="createNewChat()">æ–°å»ºèŠå¤©</button>
            <div class="chat-list" id="chat-list"></div>
        </nav>
        <div class="chat-container">
            <div class="chat-header">
                AIåœ¨çº¿é—®ç­”
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="prompt" onkeyup="chatKeyup(event)" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯...">
                <button onclick="sendMessage()" id="send_btn">å‘é€</button>
                <button id="stop-response" onclick="stopResponse()" style="display: none;">åœæ­¢å“åº”</button>
            </div>
        </div>
    </div>
</div>
<script>
    // ä¾§è¾¹æ æŠ˜å 
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle');
    let isSidebarCollapsed = false;
    sidebarToggleBtn.onclick = function() {
        isSidebarCollapsed = !isSidebarCollapsed;
        sidebar.classList.toggle('collapsed', isSidebarCollapsed);
        sidebarToggleBtn.innerHTML = isSidebarCollapsed ? '>' : '&lt;';
    };

    // èŠå¤©ä¼šè¯æ•°æ®ç®¡ç†ï¼ˆæ¯ä¸ªä¼šè¯æœ‰ç‹¬ç«‹çš„sessionIdï¼‰
    let chatSessions = []; // [{ id, name, sessionId, messages:[{role, content}] }]
    let currentChatId = null;
    let evtSource = null;
    let isStopped = true;
    let aiBuffer = '';

    // åˆå§‹åŒ–
    function init() {
        createNewChat(); // é»˜è®¤æ–°å»ºä¼šè¯
    }

    function changeModel() {
        let chat = chatSessions.find(c => c.id === currentChatId);
        if (!chat) return;
        let count =  chat.messages.length;
        console.log("ä¼šè¯æ¬¡æ•°:" + count)
        if (count > 0) {
            createNewChat();
        }
    }

    // æ–°å»ºèŠå¤©ï¼šç”Ÿæˆæ–°çš„sessionIdå¹¶å…³è”åˆ°ä¼šè¯
    function createNewChat() {
        let newId = Math.random().toString(36).substr(2, 10);
        let newSessionId = Math.random().toString(36).substring(2); // æ–° sessionId
        let chatName = "æ–°å¯¹è¯ " + (chatSessions.length + 1);
        chatSessions.push({
            id: newId,
            name: chatName,
            sessionId: newSessionId,
            messages: []
        });
        currentChatId = newId;
        renderChatList();
        renderChatMessages();
        stopResponse();
    }

    // æ¸²æŸ“å·¦ä¾§ä¼šè¯åˆ—è¡¨
    function renderChatList() {
        let list = document.getElementById('chat-list');
        list.innerHTML = '';
        chatSessions.forEach(chat => {
            let item = document.createElement('div');
            item.className = 'chat-list-item' + (chat.id === currentChatId ? ' active' : '');
            item.textContent = chat.name;
            item.title = 'sessionId: ' + chat.sessionId;
            item.onclick = function () {
                if (!isStopped) stopResponse();
                currentChatId = chat.id;
                renderChatList();
                renderChatMessages();
            };
            list.appendChild(item);
        });
    }

    // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
    function renderChatMessages() {
        let container = document.getElementById('chat-messages');
        container.innerHTML = '';
        let chat = chatSessions.find(c => c.id === currentChatId);
        if (!chat) return;
        chat.messages.forEach(msg => {
            if (msg.role === 'user') {
                let d = document.createElement('div');
                d.className = 'message user-message';
                d.textContent = msg.content;
                container.appendChild(d);
            } else if (msg.role === 'ai') {
                let d = document.createElement('div');
                d.className = 'message ai-message';
                // ä½¿ç”¨ marked.js è§£æ AI æ¶ˆæ¯ï¼Œè½¬æ¢ Markdown ä¸º HTML
                d.innerHTML = marked.parse(msg.content);
                console.log("innerHtml:" + d.innerHTML);
                container.appendChild(d);
            }
        });
        container.scrollTop = container.scrollHeight;
    }

    function chatKeyup(event) {
        if (event.keyCode === 13 && isStopped) {
            sendMessage();
        }
    }

    function sendMessage() {
        let prompt = document.getElementById('prompt').value.trim();
        if (prompt === '' || !currentChatId) return;

        // éšè—å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®
        document.getElementById('send_btn').style.display = 'none';
        document.getElementById('stop-response').style.display = 'inline-block';
        isStopped = false;

        let chat = chatSessions.find(c => c.id === currentChatId);
        if (!chat) return;

        // ä¿å­˜ç”¨æˆ·æé—®
        chat.messages.push({ role: 'user', content: prompt });

        // æ¸²æŸ“èŠå¤©å®¤çš„æ¶ˆæ¯
        renderChatMessages();

        // æ·»åŠ åŠ è½½åŠ¨ç”»
        let loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai-message loading-animation';
        loadingDiv.innerHTML = '<span>ğŸ¤– å¤„ç†ä¸­</span><span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>';
        document.getElementById('chat-messages').appendChild(loadingDiv);
        console.log("å°† loadingDiv æ·»åŠ åˆ° DOM ä¸­...");
        document.getElementById('prompt').value = "";

        // Mock AI æ¶ˆæ¯ (é¢„ç•™ AI æ¶ˆæ¯çš„ä½ç½®)
        chat.messages.push({ role: 'ai', content: '' });

        let aiMsgIdx = chat.messages.length - 1;
        aiBuffer = '';
        let sessionId = chat.sessionId;   // æ¯ä¸ªä¼šè¯ç”¨ç‹¬ç«‹sessionId
        let modelType = document.getElementById('model-select').value;

        evtSource = new EventSource(`/chat?sessionId=${sessionId}&prompt=${encodeURIComponent(prompt)}&model=${encodeURIComponent(modelType)}`);

        evtSource.onmessage = function(event) {
            // æ›´æ–° AI æ¶ˆæ¯ï¼Œç§»é™¤åŠ è½½åŠ¨ç”»
            if (loadingDiv) {
                loadingDiv.remove();
                loadingDiv = null;
            }

            aiBuffer += event.data;
            chat.messages[aiMsgIdx].content = aiBuffer;
            renderChatMessages();
        };

        evtSource.onerror = function() {
            // å…³é—­äº‹ä»¶æºå¹¶éšè—åœæ­¢æŒ‰é’®
            evtSource.close();
            isStopped = true;
            document.getElementById('stop-response').style.display = 'none';
            document.getElementById('send_btn').style.display = '';

            // ç§»é™¤åŠ è½½åŠ¨ç”»
            if (loadingDiv) {
                loadingDiv.remove();
                loadingDiv = null;
            }
        };
    }

    function stopResponse() {
        isStopped = true;
        document.getElementById('stop-response').style.display = 'none';
        document.getElementById('send_btn').style.display = '';
        if (evtSource) evtSource.close();
        let chat = chatSessions.find(c => c.id === currentChatId);
        if(chat && chat.sessionId) {
            fetch(`/chat/stop?sessionId=${chat.sessionId}`, {method: 'POST'});
        }
    }

    window.onload = init;
</script>
</body>
</html>
